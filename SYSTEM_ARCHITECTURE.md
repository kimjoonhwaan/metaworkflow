# Meta Workflow Orchestrator - 시스템 아키텍처

**작성일**: 2025-11-05  
**버전**: 2.0 (도메인 기반 분리)  
**상태**: 프로덕션 운영 중

---

## 📋 목차

1. [전체 시스템 아키텍처](#전체-시스템-아키텍처)
2. [계층별 아키텍처 (4-Tier)](#계층별-아키텍처-4-tier)
3. [데이터 흐름](#데이터-흐름)
4. [워크플로우 실행 아키텍처](#워크플로우-실행-아키텍처)
5. [RAG 검색 아키텍처](#rag-검색-아키텍처)
6. [트리거 시스템 아키텍처](#트리거-시스템-아키텍처)
7. [마이크로서비스 간 통신](#마이크로서비스-간-통신)
8. [배포 아키텍처](#배포-아키텍처)
9. [보안 아키텍처](#보안-아키텍처)
10. [성능 최적화 구조](#성능-최적화-구조)

---

## 전체 시스템 아키텍처

### **고레벨 개요**

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│              🎨 Presentation Layer (Streamlit UI)                  │
│                                                                     │
│   ┌──────────────┬──────────────┬──────────────┬──────────────┐   │
│   │ 1_Create     │ 2_Workflows  │ 3_Knowledge  │ 4_Triggers   │   │
│   │ Workflow     │ Management   │ Base         │ Management   │   │
│   └──────────────┴──────────────┴──────────────┴──────────────┘   │
│                                                                     │
└─────────────────────────┬───────────────────────────────────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│           🧠 Business Logic Layer (Services & Agents)             │
│                                                                     │
│  ┌─────────────────┐  ┌──────────────┐  ┌──────────────────────┐ │
│  │ MetaAgent       │  │ WorkflowEngine│ │ RAGService          │ │
│  │ - LLM 호출      │  │ - LangGraph  │ │ - 검색               │ │
│  │ - 코드 생성     │  │ - 스텝 실행  │ │ - 임베딩             │ │
│  │ - 워크플로우    │  │ - 상태 관리  │ │ - 도메인 분리        │ │
│  │  생성           │  │              │ │                      │ │
│  └─────────────────┘  └──────────────┘  └──────────────────────┘ │
│                                                                     │
│  ┌──────────────────┐  ┌──────────────┐  ┌──────────────────────┐ │
│  │ DomainService    │  │ FileService  │  │ TriggerScheduler    │ │
│  │ - 도메인 관리    │  │ - 파일 I/O   │  │ - 트리거 검사       │ │
│  │ - 키워드 매칭    │  │ - 문서 변환  │  │ - 워크플로우 실행   │ │
│  │                  │  │ - 업로드     │  │                      │ │
│  └──────────────────┘  └──────────────┘  └──────────────────────┘ │
│                                                                     │
│  ┌──────────────────┐  ┌──────────────┐  ┌──────────────────────┐ │
│  │ CodeValidator    │  │ StepExecutor │  │ WorkflowModifier    │ │
│  │ - AST 검증       │  │ - Python실행 │  │ - 워크플로우 수정   │ │
│  │ - f-string 검증  │  │ - subprocess │  │ - 재생성             │ │
│  │ - import 검증    │  │ - 타임아웃   │  │                      │ │
│  └──────────────────┘  └──────────────┘  └──────────────────────┘ │
│                                                                     │
└─────────────────────────┬───────────────────────────────────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│              📦 Data Access Layer (Repository Pattern)             │
│                                                                     │
│  ┌─────────────────────┐      ┌──────────────────────┐           │
│  │ SQLAlchemy ORM      │      │ ChromaDB Manager     │           │
│  │                     │      │                      │           │
│  │ - Workflow          │      │ - Collection Manager │           │
│  │ - Document          │      │ - Embedding Ops     │           │
│  │ - KnowledgeBase     │      │                      │           │
│  │ - Trigger           │      │                      │           │
│  │ - Domain            │      │                      │           │
│  └─────────────────────┘      └──────────────────────┘           │
│                                                                     │
└─────────────────────────┬───────────────────────────────────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│              💾 Data Storage Layer (DB & Vector Store)             │
│                                                                     │
│  ┌──────────────────────────┐  ┌────────────────────────────────┐ │
│  │  SQLite / PostgreSQL     │  │      ChromaDB                 │ │
│  │  (관계형 데이터베이스)    │  │  (벡터 데이터베이스)         │ │
│  │                          │  │                                │ │
│  │ ├─ workflows.db          │  │ ├─ collection_common          │ │
│  │ │  ├─ workflows          │  │ │  ├─ 메타데이터 임베딩      │ │
│  │ │  ├─ workflow_steps     │  │ │  ├─ 공통 문서               │ │
│  │ │  └─ step_outputs       │  │ │  └─ HNSW 인덱스            │ │
│  │ │                        │  │ │                              │ │
│  │ ├─ documents            │  │ ├─ collection_naver            │ │
│  │ │  ├─ id                │  │ │  ├─ 네이버 문서              │ │
│  │ │  ├─ content           │  │ │  └─ 임베딩 저장              │ │
│  │ │  ├─ title             │  │ │                              │ │
│  │ │  └─ domain            │  │ ├─ collection_weather          │ │
│  │ │                        │  │ │  └─ 날씨 관련 문서           │ │
│  │ ├─ domains              │  │ │                              │ │
│  │ │  ├─ name              │  │ └─ collection_xxxx             │ │
│  │ │  ├─ keywords          │  │    (동적 생성)                 │ │
│  │ │  └─ collection_name   │  │                                │ │
│  │ │                        │  │                                │ │
│  │ └─ triggers             │  │                                │ │
│  │    ├─ trigger_type      │  │                                │ │
│  │    ├─ schedule          │  │                                │ │
│  │    └─ status            │  │                                │ │
│  │                          │  │                                │ │
│  └──────────────────────────┘  └────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

External Services
├─ OpenAI API (GPT-4, Embeddings)
├─ Email Service (SMTP)
├─ File Storage (S3, Local)
└─ Webhook Endpoints
```

---

## 계층별 아키텍처 (4-Tier)

### **1️⃣ Presentation Layer (UI)**

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                   📱 Streamlit Web App                          │
│                                                                 │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐   │
│  │ Page 1: Create │  │ Page 2: Manage │  │ Page 3: View   │   │
│  │ Workflow       │  │ Workflows      │  │ Knowledge Base │   │
│  ├────────────────┤  ├────────────────┤  ├────────────────┤   │
│  │ • Natural Lang │  │ • List Workflow│  │ • Search Docs  │   │
│  │ • Auto Generate│  │ • Run Workflow │  │ • Preview Cont │   │
│  │ • Edit/Modify  │  │ • View Logs    │  │ • Domain Stats │   │
│  │ • Test Workflow│  │ • Delete WF    │  │ • Add Document │   │
│  └────────────────┘  └────────────────┘  └────────────────┘   │
│                                                                 │
│  ┌────────────────┐  ┌────────────────┐                        │
│  │ Page 4: Trigger│  │ Settings       │                        │
│  │ Management     │  │                │                        │
│  ├────────────────┤  ├────────────────┤                        │
│  │ • Create       │  │ • API Keys     │                        │
│  │ • Schedule     │  │ • Preferences  │                        │
│  │ • Monitor      │  │ • About        │                        │
│  │ • Logs         │  │                │                        │
│  └────────────────┘  └────────────────┘                        │
│                                                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                   st.write(), st.button(),
                     st.input(), etc.
                             │
                             ↓
```

### **2️⃣ Business Logic Layer (Services & Agents)**

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│              🧠 MetaWorkflowAgent                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 역할: 자연어 쿼리를 워크플로우로 변환                │   │
│  │                                                      │   │
│  │ 1. 사용자 자연어 요청 받음                           │   │
│  │    └─ "네이버에서 경제 뉴스 3개 수집해서 요약해"    │   │
│  │                                                      │   │
│  │ 2. RAGService로 관련 문서 검색                       │   │
│  │    └─ 네이버 API, REST API, 요약 기법 등            │   │
│  │                                                      │   │
│  │ 3. LLM(GPT-4)에 프롬프트 + 컨텍스트 전달           │   │
│  │    └─ 온도: 1, 추론: minimal                        │   │
│  │                                                      │   │
│  │ 4. 코드 생성                                         │   │
│  │    └─ Python 워크플로우 코드                        │   │
│  │                                                      │   │
│  │ 5. CodeValidator로 검증                             │   │
│  │    └─ AST, f-string, import 확인                    │   │
│  │                                                      │   │
│  │ 6. 최종 워크플로우 반환                              │   │
│  │    └─ JSON 형식 (steps, variables, etc.)            │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│              ⚙️ WorkflowEngine (LangGraph)                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 역할: 워크플로우 실행 & 상태 관리                    │   │
│  │                                                      │   │
│  │ LangGraph 상태 머신:                                 │   │
│  │                                                      │   │
│  │   START → PLAN → EXECUTE → EVALUATE → END           │   │
│  │             ↑                    ↓                   │   │
│  │             └────────────────────┘                   │   │
│  │               (재시도/수정 루프)                    │   │
│  │                                                      │   │
│  │ • 각 스텝 순서대로 실행                              │   │
│  │ • 조건부 분기 처리                                   │   │
│  │ • 에러 처리 & 재시도                                 │   │
│  │ • 상태 저장 & 조회                                   │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│              🔍 RAGService (검색 엔진)                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 역할: 문서 검색 & 관련 정보 검색                     │   │
│  │                                                      │   │
│  │ 스마트 검색 (Smart Search):                          │   │
│  │   쿼리 → 도메인 감지 → 메타데이터 검색              │   │
│  │   → 콘텐츠 로드 → 결과 반환                         │   │
│  │                                                      │   │
│  │ 메타데이터 기반:                                     │   │
│  │   • ChromaDB: 메타데이터 임베딩 저장                │   │
│  │   • SQLite: 전체 문서 내용 저장                      │   │
│  │                                                      │   │
│  │ 도메인 분리:                                         │   │
│  │   • collection_naver, collection_weather, ...        │   │
│  │   • collection_common (항상 포함)                    │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│              🔨 StepExecutor (스텝 실행)                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 역할: 각 워크플로우 스텝 실행                        │   │
│  │                                                      │   │
│  │ 지원 스텝 타입:                                      │   │
│  │   1. LLM_CALL: GPT-4 호출                           │   │
│  │   2. API_CALL: HTTP 요청                            │   │
│  │   3. PYTHON_SCRIPT: 격리된 subprocess 실행          │   │
│  │   4. CONDITION: if-else 분기                        │   │
│  │   5. APPROVAL: 사용자 승인                          │   │
│  │   6. NOTIFICATION: 알림 전송                        │   │
│  │   7. DATA_TRANSFORM: 데이터 변환                    │   │
│  │                                                      │   │
│  │ 보안 메커니즘:                                       │   │
│  │   • Subprocess 격리 (독립 메모리)                    │   │
│  │   • 타임아웃 보호 (300초 기본)                       │   │
│  │   • JSON 기반 변수 전달                              │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### **3️⃣ Data Access Layer (Repository Pattern)**

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│              📊 SQLAlchemy ORM (관계형 DB)                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 역할: SQLite/PostgreSQL 데이터 접근                  │   │
│  │                                                      │   │
│  │ 모델:                                                │   │
│  │   • Workflow: 워크플로우 정의 & 메타데이터          │   │
│  │   • WorkflowStep: 각 스텝 정의                       │   │
│  │   • WorkflowExecution: 실행 결과 & 로그              │   │
│  │   • Document: 문서 내용 & 메타데이터                │   │
│  │   • DocumentMetadata: 검색 가능한 메타데이터        │   │
│  │   • Domain: 도메인 정의 & 키워드                     │   │
│  │   • Trigger: 트리거 설정 & 상태                      │   │
│  │   • KnowledgeBase: 문서 컬렉션                       │   │
│  │                                                      │   │
│  │ ORM 특징:                                            │   │
│  │   • 객체-관계 매핑                                   │   │
│  │   • 자동 타입 변환                                   │   │
│  │   • Relationship 자동 관리                           │   │
│  │   • Transaction 관리                                 │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│              🔤 ChromaDB Manager (벡터 DB)                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 역할: 벡터 데이터 저장 & 검색                        │   │
│  │                                                      │   │
│  │ 특징:                                                │   │
│  │   • 임베딩만 저장 (메타데이터)                       │   │
│  │   • 1536차원 벡터 (text-embedding-3-small)          │   │
│  │   • HNSW 인덱싱 (빠른 검색)                          │   │
│  │   • 컬렉션별 분리 (도메인별)                         │   │
│  │   • 코사인 유사도 검색                               │   │
│  │                                                      │   │
│  │ 컬렉션:                                              │   │
│  │   • collection_common (공통)                         │   │
│  │   • collection_naver (네이버)                        │   │
│  │   • collection_weather (기상청)                      │   │
│  │   • ... (동적 생성)                                  │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### **4️⃣ Data Storage Layer (Persistence)**

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│              💾 SQLite / PostgreSQL                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │  workflows.db                                        │   │
│  │  │                                                   │   │
│  │  ├─ workflows                                        │   │
│  │  │  ├─ id (PK)                                       │   │
│  │  │  ├─ name, description                             │   │
│  │  │  ├─ workflow_json (전체 정의)                     │   │
│  │  │  ├─ status (draft/active/archived)                │   │
│  │  │  └─ created_at, updated_at                        │   │
│  │  │                                                   │   │
│  │  ├─ workflow_steps                                   │   │
│  │  │  ├─ id (PK), workflow_id (FK)                     │   │
│  │  │  ├─ step_order                                    │   │
│  │  │  ├─ step_type (LLM_CALL, API_CALL, ...)          │   │
│  │  │  ├─ configuration (step 설정)                     │   │
│  │  │  └─ status (pending/running/completed/error)      │   │
│  │  │                                                   │   │
│  │  ├─ workflow_executions                              │   │
│  │  │  ├─ id (PK), workflow_id (FK)                     │   │
│  │  │  ├─ status (running/success/failed)                │   │
│  │  │  ├─ started_at, completed_at                      │   │
│  │  │  ├─ total_steps, completed_steps                  │   │
│  │  │  └─ error_message                                 │   │
│  │  │                                                   │   │
│  │  ├─ documents                                        │   │
│  │  │  ├─ id (PK), knowledge_base_id (FK)               │   │
│  │  │  ├─ title, content                                │   │
│  │  │  ├─ domain (naver/weather/common/...)             │   │
│  │  │  ├─ tags, metadata                                │   │
│  │  │  ├─ content_type (PDF/TXT/JSON/...)               │   │
│  │  │  └─ is_processed                                  │   │
│  │  │                                                   │   │
│  │  ├─ document_metadata                                │   │
│  │  │  ├─ id (PK), document_id (FK)                     │   │
│  │  │  ├─ keywords, technologies                        │   │
│  │  │  ├─ description, category                         │   │
│  │  │  ├─ searchable_text (임베딩할 텍스트)             │   │
│  │  │  └─ embedding_id (ChromaDB 참조)                  │   │
│  │  │                                                   │   │
│  │  ├─ domains                                          │   │
│  │  │  ├─ id (PK)                                       │   │
│  │  │  ├─ name (naver/weather/kakao/...)                │   │
│  │  │  ├─ keywords ([naver, NAVER, 네이버])             │   │
│  │  │  ├─ collection_name (collection_naver)            │   │
│  │  │  ├─ is_common (True/False)                        │   │
│  │  │  ├─ is_active (True/False)                        │   │
│  │  │  ├─ document_count                                │   │
│  │  │  └─ last_used_at                                  │   │
│  │  │                                                   │   │
│  │  └─ triggers                                         │   │
│  │     ├─ id (PK)                                       │   │
│  │     ├─ workflow_id (FK)                              │   │
│  │     ├─ trigger_type (SCHEDULED/EVENT/WEBHOOK/...)    │   │
│  │     ├─ status (active/paused/inactive)                │   │
│  │     ├─ schedule_expression (cron)                     │   │
│  │     ├─ last_triggered_at                             │   │
│  │     └─ next_trigger_at                               │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│              🔤 ChromaDB (벡터 데이터)                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │  ./data/chroma_db/                                   │   │
│  │  │                                                   │   │
│  │  ├─ collection_common/                               │   │
│  │  │  ├─ index/ (HNSW 벡터 인덱스)                     │   │
│  │  │  ├─ data/ (메타데이터 & 임베딩)                   │   │
│  │  │  └─ metadata.parquet                              │   │
│  │  │                                                   │   │
│  │  ├─ collection_naver/                                │   │
│  │  │  └─ (위와 동일 구조)                              │   │
│  │  │                                                   │   │
│  │  ├─ collection_weather/                              │   │
│  │  │  └─ (위와 동일 구조)                              │   │
│  │  │                                                   │   │
│  │  └─ collection_*/                                    │   │
│  │     └─ (동적 생성된 도메인 컬렉션)                   │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 데이터 흐름

### **1. 워크플로우 생성 흐름**

```
사용자 (UI)
    │
    └─ 자연어 입력
       "네이버 경제 뉴스 3개 요약 후 메일 발송"
       │
       ↓
┌──────────────────────────────────────────────┐
│  1_Create_Workflow.py (Streamlit)            │
├──────────────────────────────────────────────┤
│  • 입력 받기                                  │
│  • 입력 검증                                  │
│  • MetaWorkflowAgent에 전달                  │
└───────────────┬──────────────────────────────┘
                │
                ↓
┌──────────────────────────────────────────────┐
│  MetaWorkflowAgent                           │
├──────────────────────────────────────────────┤
│  1. RAGService.get_relevant_context()        │
│     ├─ 도메인 감지: "naver"                 │
│     ├─ 메타데이터 검색: 5개 문서            │
│     └─ 전체 콘텐츠 로드                      │
│                                              │
│  2. LLM(GPT-4) 호출                         │
│     ├─ 프롬프트: 자연어 + 컨텍스트         │
│     ├─ 온도: 1, 추론: minimal              │
│     └─ 응답: Python 워크플로우 코드        │
│                                              │
│  3. CodeValidator                           │
│     ├─ AST 문법 검증                       │
│     ├─ f-string 검증                       │
│     └─ import 검증                         │
│                                              │
│  4. 워크플로우 JSON 생성                    │
│     ├─ 스텝 정의                            │
│     ├─ 변수 정의                            │
│     └─ 메타데이터                           │
└───────────────┬──────────────────────────────┘
                │
                ↓
┌──────────────────────────────────────────────┐
│  SQLite (workflows)                          │
├──────────────────────────────────────────────┤
│  • workflow 레코드 저장                      │
│  • workflow_steps 저장                       │
│  • 상태: "draft" → "active"                 │
└───────────────┬──────────────────────────────┘
                │
                ↓
        워크플로우 생성 완료! ✅
```

### **2. 워크플로우 실행 흐름**

```
사용자 (UI)
    │
    └─ "Run Workflow" 클릭
       │
       ↓
┌──────────────────────────────────────────────┐
│  2_Workflows.py (Streamlit)                  │
├──────────────────────────────────────────────┤
│  • 워크플로우 로드                            │
│  • WorkflowEngine에 전달                    │
└───────────────┬──────────────────────────────┘
                │
                ↓
┌──────────────────────────────────────────────────────────┐
│  WorkflowEngine (LangGraph 상태 머신)                    │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  State 초기화:                                          │
│  {                                                      │
│    "current_step": 0,                                   │
│    "variables": {...},                                  │
│    "step_outputs": [],                                  │
│    "status": "running"                                  │
│  }                                                      │
│                                                          │
│  LangGraph 흐름:                                        │
│                                                          │
│  START                                                  │
│    │                                                    │
│    ↓                                                    │
│  PLAN (다음 스텝 결정)                                 │
│    │                                                    │
│    ├─ Step 0 실행? → Step 1 준비?                      │
│    │                                                    │
│    ↓                                                    │
│  EXECUTE (스텝 실행)                                   │
│    │                                                    │
│    ├─ StepExecutor에 위임                             │
│    │  ├─ LLM_CALL, API_CALL, PYTHON_SCRIPT, ...      │
│    │  └─ 출력 → variables에 저장                      │
│    │                                                    │
│    ↓                                                    │
│  EVALUATE (결과 평가)                                 │
│    │                                                    │
│    ├─ 성공?                                            │
│    │  ├─ 다음 스텝 있음? → PLAN으로 돌아감           │
│    │  └─ 모든 스텝 완료? → END                        │
│    │                                                    │
│    └─ 실패?                                            │
│       ├─ 재시도 가능? → 재시도                        │
│       └─ 아니면? → 에러 처리 → END                    │
│                                                          │
│  END (완료)                                             │
│                                                          │
└───────────────┬──────────────────────────────────────────┘
                │
                ↓
┌──────────────────────────────────────────────┐
│  SQLite (workflow_executions)                │
├──────────────────────────────────────────────┤
│  • 실행 레코드 저장                          │
│  • 각 스텝 실행 로그                         │
│  • 최종 상태: "success" / "failed"          │
└───────────────┬──────────────────────────────┘
                │
                ↓
    워크플로우 실행 완료! ✅
```

### **3. 문서 검색 흐름**

```
사용자 (검색어 입력)
    │
    └─ "네이버 API"
       │
       ↓
┌──────────────────────────────────────────────┐
│  5_Knowledge_Base.py (검색 폼)              │
├──────────────────────────────────────────────┤
│  • 검색어 입력받기                            │
│  • RAGService.smart_search() 호출            │
└───────────────┬──────────────────────────────┘
                │
                ↓
┌──────────────────────────────────────────────┐
│  RAGService.smart_search()                   │
├──────────────────────────────────────────────┤
│  1. DomainService.find_domain_by_keywords()  │
│     ├─ "네이버" 키워드 매칭                  │
│     └─ 반환: Domain(name="naver")            │
│                                              │
│  2. 임베딩 생성                              │
│     ├─ OpenAI API: text-embedding-3-small   │
│     └─ 1536차원 벡터 생성                    │
│                                              │
│  3. ChromaDB 검색 (2개 컬렉션)               │
│     ├─ collection_naver.query()              │
│     │  └─ 코사인 유사도 검색 (상위 5개)    │
│     │                                        │
│     └─ collection_common.query()             │
│        └─ 코사인 유사도 검색 (상위 5개)    │
│                                              │
│  4. 결과 병합 & 정렬                         │
│     ├─ 중복 제거                             │
│     ├─ 유사도 순 정렬                        │
│     └─ 상위 5개 반환                         │
└───────────────┬──────────────────────────────┘
                │
                ↓
┌──────────────────────────────────────────────┐
│  RAGService.get_full_content()               │
├──────────────────────────────────────────────┤
│  1. document_id 추출                         │
│  2. SQLite Document 로드                     │
│  3. 전체 콘텐츠 반환                         │
└───────────────┬──────────────────────────────┘
                │
                ↓
    최종 검색 결과 표시! ✅
    (제목, 도메인, 유사도, 전체 콘텐츠)
```

---

## 워크플로우 실행 아키텍처

### **상세 실행 흐름**

```
┌─────────────────────────────────────────────────────────────┐
│                  WorkflowEngine                             │
│                  (LangGraph 상태 머신)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  State Graph:                                              │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  State Dictionary                                   │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ {                                                   │   │
│  │   "workflow_id": "wf_123",                         │   │
│  │   "current_step_index": 0,                         │   │
│  │   "total_steps": 5,                                │   │
│  │   "status": "running",                             │   │
│  │   "variables": {                                   │   │
│  │     "user_request": "...",                         │   │
│  │     "naver_url": "...",                            │   │
│  │     "api_key": "..."                               │   │
│  │   },                                               │   │
│  │   "step_outputs": {                                │   │
│  │     "step_0": {"articles": [...]},                 │   │
│  │     "step_1": {"summary": "..."}                    │   │
│  │   },                                               │   │
│  │   "error_log": "",                                 │   │
│  │   "retries": 0                                     │   │
│  │ }                                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  노드 (Node = 실행 함수):                                  │
│                                                             │
│  1. plan_next_step()                                       │
│     ├─ current_step_index 확인                            │
│     ├─ 모든 스텝 완료? → "end"로 이동                     │
│     └─ 아니면 → "execute"로 이동                         │
│                                                             │
│  2. execute_step()                                         │
│     ├─ 현재 스텝 가져오기                                 │
│     ├─ step_type 확인 (LLM_CALL, API_CALL, ...)           │
│     ├─ StepExecutor에 위임                               │
│     ├─ 결과를 step_outputs에 저장                        │
│     ├─ variables 업데이트                                │
│     └─ 다음 상태: "evaluate"                             │
│                                                             │
│  3. evaluate_step()                                        │
│     ├─ 실행 성공?                                         │
│     │  ├─ current_step_index++                           │
│     │  └─ 다음 상태: "plan"                              │
│     │                                                      │
│     └─ 실행 실패?                                         │
│        ├─ retries < max_retries?                         │
│        │  ├─ retries++                                   │
│        │  └─ 다음 상태: "execute" (재시도)              │
│        │                                                  │
│        └─ 재시도 초과?                                    │
│           ├─ status = "failed"                           │
│           └─ 다음 상태: "end"                            │
│                                                             │
│  4. end_workflow()                                         │
│     ├─ 최종 상태 업데이트                                 │
│     ├─ 로그 저장                                          │
│     └─ 반환                                               │
│                                                             │
│  엣지 (Edge = 상태 전이):                                  │
│                                                             │
│  START → plan_next_step → execute_step                     │
│           ↑                    ↓                           │
│           └─ evaluate_step ←────                          │
│                  ↓                                         │
│              end_workflow → END                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## RAG 검색 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                   RAGService                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ DomainService (도메인 관리)                             │
│  │  ├─ 모든 도메인 로드 (캐시됨)                           │
│  │  ├─ 키워드 매칭으로 도메인 감지                         │
│  │  └─ Collection 이름 생성 (정규화)                      │
│  │                                                          │
│  ├─ smart_search(query)                                    │
│  │  ├─ 1. 도메인 감지                                     │
│  │  │    └─ find_domain_by_keywords(query)                │
│  │  │                                                      │
│  │  ├─ 2. 쿼리 임베딩 생성                                │
│  │  │    └─ OpenAI API (캐시됨)                           │
│  │  │                                                      │
│  │  ├─ 3. ChromaDB 메타데이터 검색                        │
│  │  │    ├─ 감지된 도메인 컬렉션 검색                     │
│  │  │    ├─ common 도메인 컬렉션 검색                     │
│  │  │    └─ 코사인 유사도로 정렬                          │
│  │  │                                                      │
│  │  ├─ 4. SQLite 콘텐츠 로드                             │
│  │  │    └─ 메타데이터 결과에서 document_id로 검색        │
│  │  │                                                      │
│  │  └─ 5. 최종 결과 반환                                  │
│  │     └─ [{"title", "content", "score", "domain"}, ...]  │
│  │                                                          │
│  └─ ChromaDB Collections (도메인별)                        │
│     │                                                      │
│     ├─ collection_common                                   │
│     │  ├─ 메타데이터: 임베딩 (1536-dim)                   │
│     │  ├─ 문서: 공통 문서들                               │
│     │  └─ 인덱스: HNSW (코사인 유사도)                    │
│     │                                                      │
│     ├─ collection_naver                                    │
│     │  ├─ 메타데이터: 네이버 API 임베딩                   │
│     │  ├─ 문서: 네이버 관련 문서                          │
│     │  └─ 인덱스: HNSW                                    │
│     │                                                      │
│     ├─ collection_weather                                  │
│     │  └─ (위와 동일 구조)                                │
│     │                                                      │
│     └─ collection_*                                        │
│        └─ (동적 생성된 도메인 컬렉션)                      │
│                                                             │
│  SQLite (Document Storage)                                 │
│  ├─ documents 테이블                                       │
│  │  ├─ id, title, content                                 │
│  │  ├─ domain_id, kb_id                                   │
│  │  └─ metadata (JSON)                                    │
│  │                                                          │
│  └─ document_metadata 테이블                               │
│     ├─ searchable_text (임베딩 텍스트)                     │
│     ├─ keywords, technologies                             │
│     ├─ doc_type, category                                 │
│     └─ embedding_id (ChromaDB 참조)                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 트리거 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                   Trigger System                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Trigger Manager (CRUD)                                 │
│  │  ├─ create_trigger()                                   │
│  │  ├─ get_trigger()                                      │
│  │  ├─ update_trigger()                                   │
│  │  └─ delete_trigger()                                   │
│  │                                                          │
│  ├─ TriggerScheduler (Background Service)                  │
│  │  ├─ 주기적 체크 (60초마다)                              │
│  │  ├─ 트리거 조건 평가                                    │
│  │  └─ 워크플로우 실행                                     │
│  │                                                          │
│  └─ Trigger Types:                                         │
│     │                                                       │
│     ├─ SCHEDULED (정기 실행)                               │
│     │  ├─ Cron 표현식                                     │
│     │  ├─ 예: "0 9 * * MON" (매주 월요일 9시)             │
│     │  └─ 다음 실행 시간 자동 계산                         │
│     │                                                       │
│     ├─ EVENT (이벤트 기반)                                 │
│     │  ├─ 파일 업로드                                     │
│     │  ├─ 데이터 변경                                     │
│     │  └─ 외부 이벤트                                     │
│     │                                                       │
│     ├─ WEBHOOK (웹훅)                                      │
│     │  ├─ HTTP POST 수신                                  │
│     │  ├─ 외부 시스템 연동                                │
│     │  └─ 실시간 트리거                                   │
│     │                                                       │
│     └─ MANUAL (수동)                                       │
│        ├─ UI에서 버튼 클릭                                 │
│        └─ 즉시 실행                                        │
│                                                             │
│  실행 흐름:                                                 │
│                                                             │
│  TriggerScheduler (run_scheduler.py)                       │
│    ↓                                                        │
│  매 60초마다 활성 트리거 확인                                │
│    ↓                                                        │
│  next_trigger_at ≤ 현재 시간?                             │
│    ├─ YES → 워크플로우 실행                                │
│    │        ├─ WorkflowEngine 호출                        │
│    │        ├─ 실행 로그 저장                             │
│    │        └─ last_triggered_at, next_trigger_at 업데이트│
│    │                                                       │
│    └─ NO → 다음 체크 대기                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘

  데이터베이스:
  
  triggers 테이블
  ├─ id (PK)
  ├─ workflow_id (FK)
  ├─ trigger_type (SCHEDULED/EVENT/WEBHOOK/MANUAL)
  ├─ status (active/paused/inactive)
  ├─ schedule_expression (cron)
  ├─ last_triggered_at
  ├─ next_trigger_at
  └─ created_at, updated_at
```

---

## 마이크로서비스 간 통신

```
┌─────────────────────────────────────────────────────────────┐
│              Service Communication Pattern                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Synchronous (동기):                                        │
│                                                             │
│  ┌─────────────┐                                           │
│  │ Streamlit   │                                           │
│  └──────┬──────┘                                           │
│         │ HTTP (streamlit state)                           │
│         ↓                                                   │
│  ┌─────────────┐                                           │
│  │ RAGService  │ ← Eager response required                │
│  └──────┬──────┘                                           │
│         │ SQLAlchemy                                       │
│         ↓                                                   │
│  ┌─────────────┐                                           │
│  │ SQLite/     │                                           │
│  │ ChromaDB    │                                           │
│  └─────────────┘                                           │
│                                                             │
│  비동기 (Asynchronous):                                     │
│                                                             │
│  ┌─────────────┐                                           │
│  │ Streamlit   │                                           │
│  └──────┬──────┘                                           │
│         │ async/await                                      │
│         ↓                                                   │
│  ┌─────────────────────┐                                   │
│  │ MetaWorkflowAgent   │                                   │
│  │ (async methods)     │                                   │
│  └──────┬──────────────┘                                   │
│         │ async                                            │
│         ├─→ RAGService.get_relevant_context()             │
│         ├─→ OpenAI API (embeddings)                       │
│         └─→ ChromaDB query                                 │
│                                                             │
│  격리된 프로세스:                                           │
│                                                             │
│  ┌──────────────────────────────────────┐                 │
│  │ StepExecutor                         │                 │
│  │ (_execute_python_script)             │                 │
│  └────────────────┬─────────────────────┘                 │
│                   │ subprocess.run()                       │
│                   ↓                                        │
│           ┌───────────────┐                               │
│           │ 자식 프로세스  │                               │
│           │ (Python Script)│                               │
│           │ - 독립 메모리  │                               │
│           │ - 독립 환경    │                               │
│           │ - 타임아웃     │                               │
│           └───────────────┘                               │
│                   ↓                                        │
│           JSON 결과 + stderr logs                          │
│                                                             │
│  캐싱 패턴:                                                │
│                                                             │
│  @st.cache_resource                                        │
│  def get_rag_service():                                    │
│      return RAGService()  ← 싱글톤 인스턴스               │
│                                                             │
│  @st.cache_data                                            │
│  def search_documents(query):                              │
│      return rag_service.search()                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 배포 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                  Production Deployment                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Web Server (Streamlit Cloud / Docker)             │   │
│  │  ├─ Streamlit App (port 8501)                      │   │
│  │  ├─ Main Process (API calls, UI)                   │   │
│  │  └─ Background Thread (trigger check)              │   │
│  │     └─ run_scheduler.py (60초마다 체크)            │   │
│  └────────────┬────────────────────────────────────────┘   │
│               │                                            │
│               ├─ API 호출 ──────────────┐                 │
│               │                         ↓                 │
│               │              ┌──────────────────┐         │
│               │              │  OpenAI API      │         │
│               │              │  - GPT-4         │         │
│               │              │  - Embeddings    │         │
│               │              └──────────────────┘         │
│               │                                            │
│               ├─ 파일 저장 ──────────────┐                │
│               │                         ↓                 │
│               │              ┌──────────────────┐         │
│               │              │  로컬 스토리지   │         │
│               │              │  - workflows.db  │         │
│               │              │  - chroma_db/    │         │
│               │              └──────────────────┘         │
│               │                                            │
│               └─ 외부 연동 ───────────────┐                │
│                                           ↓                │
│                              ┌──────────────────┐         │
│                              │  Email Service   │         │
│                              │  - SMTP Server   │         │
│                              │                  │         │
│                              │  File Storage    │         │
│                              │  - S3 / Drive    │         │
│                              │                  │         │
│                              │  Webhooks        │         │
│                              │  - External Sys  │         │
│                              └──────────────────┘         │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Docker 구조 (선택사항)                            │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │  Dockerfile                                         │   │
│  │  ├─ FROM python:3.11                              │   │
│  │  ├─ COPY requirements.txt                          │   │
│  │  ├─ RUN pip install -r requirements.txt            │   │
│  │  ├─ COPY . /app                                    │   │
│  │  ├─ EXPOSE 8501                                    │   │
│  │  ├─ CMD ["streamlit", "run", "app.py"]            │   │
│  │  └─ VOLUME ["/app/data"]                           │   │
│  │                                                     │   │
│  │  docker-compose.yml                                │   │
│  │  ├─ streamlit-app (main service)                   │   │
│  │  ├─ postgres (database)                            │   │
│  │  └─ volumes (persistence)                          │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 보안 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                  Security Architecture                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 인증 (Authentication)                                  │
│  ├─ 환경 변수로 API 키 관리                               │
│  │  ├─ OPENAI_API_KEY                                    │
│  │  ├─ DATABASE_URL                                      │
│  │  └─ EMAIL_PASSWORD                                    │
│  │                                                          │
│  └─ .streamlit/secrets.toml (로컬 개발)                    │
│                                                             │
│  2. 격리 (Isolation)                                       │
│  ├─ Subprocess 격리                                        │
│  │  ├─ 독립 메모리 공간                                   │
│  │  ├─ 독립 환경 변수                                     │
│  │  ├─ 독립 파일 디스크립터                               │
│  │  └─ 타임아웃 보호 (300초)                              │
│  │                                                          │
│  └─ ChromaDB 접근 제어                                     │
│     ├─ 로컬 파일 시스템 (권한 기반)                        │
│     └─ 컬렉션별 메타데이터 분리                            │
│                                                             │
│  3. 검증 (Validation)                                      │
│  ├─ 코드 검증 (CodeValidator)                             │
│  │  ├─ AST 문법 검사                                      │
│  │  ├─ Import 검증                                        │
│  │  └─ 위험 함수 감지 (제한됨)                            │
│  │                                                          │
│  ├─ 입력 검증                                              │
│  │  ├─ SQL injection 방지 (SQLAlchemy ORM)               │
│  │  ├─ XSS 방지 (Streamlit 자동)                         │
│  │  └─ JSON 검증                                         │
│  │                                                          │
│  └─ 데이터 검증                                            │
│     ├─ 타입 체크                                           │
│     └─ 범위 체크                                           │
│                                                             │
│  4. 접근 제어 (Access Control)                             │
│  ├─ 문서 소유권 (추후 구현)                                │
│  ├─ 도메인 권한 (추후 구현)                                │
│  └─ 워크플로우 권한 (추후 구현)                            │
│                                                             │
│  5. 암호화 (Encryption)                                    │
│  ├─ 전송 중 암호화 (HTTPS)                                 │
│  └─ 저장 중 암호화 (추후 구현)                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 성능 최적화 구조

```
┌─────────────────────────────────────────────────────────────┐
│                  Performance Optimization                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 캐싱 (Caching)                                          │
│  ├─ RAGService 싱글톤                                       │
│  │  ├─ @st.cache_resource (Streamlit 캐시)               │
│  │  └─ 인스턴스 재사용                                     │
│  │                                                          │
│  ├─ 임베딩 캐시                                             │
│  │  ├─ _embedding_cache = {}                              │
│  │  ├─ 키: hash(query)                                     │
│  │  └─ 반복 검색 시 API 호출 절감                          │
│  │                                                          │
│  ├─ 컬렉션 캐시                                             │
│  │  ├─ _collections_cache = {}                            │
│  │  ├─ 키: f"domain_{domain}"                             │
│  │  └─ ChromaDB I/O 절감                                   │
│  │                                                          │
│  └─ 쿼리 결과 캐시                                          │
│     ├─ @st.cache_data (Streamlit)                         │
│     └─ TTL: 세션 동안 유지                                 │
│                                                             │
│  2. 배치 처리 (Batching)                                    │
│  ├─ 다중 문서 추가                                         │
│  │  ├─ 임베딩 배치 생성                                   │
│  │  ├─ ChromaDB add_batch()                              │
│  │  └─ 네트워크 왕복 감소                                  │
│  │                                                          │
│  └─ 다중 쿼리 검색                                          │
│     ├─ 여러 도메인 동시 검색                              │
│     └─ 결과 병렬 병합                                       │
│                                                             │
│  3. 인덱싱 (Indexing)                                      │
│  ├─ ChromaDB HNSW 인덱스                                   │
│  │  ├─ 빠른 벡터 검색 (O(log n))                          │
│  │  └─ 메모리 효율적                                       │
│  │                                                          │
│  ├─ SQLite 인덱스                                          │
│  │  ├─ domain_id, kb_id (FK)                             │
│  │  └─ created_at (정렬)                                  │
│  │                                                          │
│  └─ 텍스트 검색 인덱싱                                      │
│     └─ FTS (Full Text Search, 추후)                       │
│                                                             │
│  4. 쿼리 최적화                                             │
│  ├─ 필요한 컬럼만 선택                                     │
│  ├─ Lazy Loading (관계형)                                  │
│  ├─ Eager Loading (필요시)                                 │
│  └─ N+1 쿼리 방지                                          │
│                                                             │
│  5. 리소스 관리                                             │
│  ├─ 연결 풀링                                               │
│  │  ├─ SQLAlchemy pool_size                              │
│  │  └─ ChromaDB 연결 재사용                               │
│  │                                                          │
│  ├─ 메모리 관리                                             │
│  │  ├─ Generator 사용 (대용량 데이터)                      │
│  │  └─ 적절한 타임아웃                                     │
│  │                                                          │
│  └─ 디스크 I/O 최적화                                       │
│     ├─ SSD 권장                                            │
│     └─ 배치 쓰기                                           │
│                                                             │
│  6. 모니터링 & 프로파일링                                   │
│  ├─ 로깅 (Python logging)                                  │
│  │  ├─ INFO: 주요 이벤트                                  │
│  │  ├─ DEBUG: 상세 정보                                   │
│  │  └─ ERROR: 문제점                                      │
│  │                                                          │
│  └─ 성능 메트릭 (추후)                                     │
│     ├─ 응답 시간                                           │
│     ├─ 처리량                                              │
│     └─ 리소스 사용률                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 최종 통합 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│                    사용자 (Streamlit UI)                            │
│                                                                     │
│   ┌──────────────┬──────────────┬──────────────┬──────────────┐   │
│   │ 워크플로우    │ 워크플로우    │ 문서 관리     │ 트리거        │   │
│   │ 생성         │ 실행         │ & 검색       │ 관리         │   │
│   └──────────────┴──────────────┴──────────────┴──────────────┘   │
│                                                                     │
└────────────────────────────┬────────────────────────────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ↓                    ↓                    ↓
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │MetaWorkflow │    │WorkflowEngine│   │ RAGService  │
   │Agent        │    │(LangGraph)  │    │(검색)       │
   └─────────────┘    └─────────────┘    └─────────────┘
        │ → OpenAI         │ → StepExecutor  │ → DomainService
        │   API            │ → Subprocess    │ → ChromaDB
        │                  │ → 격리 실행     │ → SQLite
        │
    ┌───┴────────────────────────────────────────┐
    │                                            │
    ↓                                            ↓
  ┌──────────────┐          ┌──────────────────────────┐
  │SQLite        │          │ChromaDB (벡터 DB)        │
  │(문서 저장)    │          │(메타데이터 임베딩)       │
  ├──────────────┤          ├──────────────────────────┤
  │workflows.db  │          │collection_common         │
  │documents     │          │collection_naver          │
  │domains       │          │collection_weather        │
  │triggers      │          │collection_*              │
  └──────────────┘          └──────────────────────────┘
        │                            │
        └────────────┬───────────────┘
                     │
             최종 결과 반환 ✅
```

---

**작성자**: Meta Workflow Orchestrator Team  
**최종 업데이트**: 2025-11-05  
**상태**: 프로덕션 운영 중 ✅

