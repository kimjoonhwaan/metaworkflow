# RAG ì²­í¬ ë¶„í™” í•´ê²° - ì „ì²´ ë¬¸ë§¥ ì „ë‹¬ ê°€ì´ë“œ

## ğŸ“‹ ë¬¸ì œì : ì²­í¬ê°€ ë„ˆë¬´ ë¶„í™”ë˜ì–´ ì „ì²´ ë¬¸ë§¥ ì†ì‹¤

### ì´ì „ ìƒí™©
```
ì›ë³¸ ë¬¸ì„œ:
"í•œêµ­ ê²½ì œê°€ ì–´ë ¤ì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤. GDP ì„±ì¥ë¥ ì´ ê°ì†Œí•˜ê³  ìˆìŠµë‹ˆë‹¤. 
 ì‹¤ì—…ë¥ ë„ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì „ ì„¸ê³„ ê²½ê¸° ì¹¨ì²´ ë•Œë¬¸ì…ë‹ˆë‹¤."

ì²­í¬ ë¶„í™” (chunk_size=500, overlap=50):
â”œâ”€ chunk_1: "í•œêµ­ ê²½ì œê°€ ì–´ë ¤ì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤. GDP"
â”œâ”€ chunk_2: "GDP ì„±ì¥ë¥ ì´ ê°ì†Œí•˜ê³  ìˆìŠµë‹ˆë‹¤..."
â”œâ”€ chunk_3: "ìˆìŠµë‹ˆë‹¤. ì‹¤ì—…ë¥ ë„ ì¦ê°€í•˜ê³ "
â””â”€ chunk_4: "...ì „ ì„¸ê³„ ê²½ê¸° ì¹¨ì²´ ë•Œë¬¸ì…ë‹ˆë‹¤"

â†“ LLMì— ì „ë‹¬ ì‹œ
"í•œêµ­ ê²½ì œê°€ ì–´ë ¤ì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤. GDP"

âŒ ë¬¸ì œ: ë‹¨ë…ìœ¼ë¡œëŠ” ì˜ë¯¸ ë¶ˆì™„ì „
âŒ ë¬¸ì œ: ì „ì²´ ë¬¸ë§¥ ì†ì‹¤
âŒ ë¬¸ì œ: LLM ìƒì„± ì½”ë“œ í’ˆì§ˆ ì €í•˜
```

---

## âœ… í•´ê²°ì±…: 3ë‹¨ê³„ ìˆœì°¨ êµ¬í˜„

### **1ï¸âƒ£ ì²­í¬ í¬ê¸°/ì˜¤ë²„ë© ì¦ê°€**

**íŒŒì¼**: `src/services/rag_service.py` ë¼ì¸ 102

```python
# ë³€ê²½ ì „
def chunk_text(self, text: str, chunk_size: int = 500, overlap: int = 50):

# ë³€ê²½ í›„
def chunk_text(self, text: str, chunk_size: int = 1000, overlap: int = 200):
```

**íš¨ê³¼**:
- ì²­í¬ í¬ê¸°: 500 â†’ **1000 í† í°** (+100%)
- ì˜¤ë²„ë©: 50 â†’ **200 í† í°** (+300%)
- ë” ê¸´ ë¬¸ë§¥ ë³´ì¡´
- ë” ê°•í•œ ì²­í¬ ê°„ ì—°ê²°

**ì˜ˆì‹œ**:
```
ì´ì „: "í•œêµ­ ê²½ì œê°€ ì–´ë ¤ì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤. GDP"
ì´í›„: "í•œêµ­ ê²½ì œê°€ ì–´ë ¤ì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤. GDP ì„±ì¥ë¥ ì´ ê°ì†Œí•˜ê³  ìˆìŠµë‹ˆë‹¤. 
      ì‹¤ì—…ë¥ ë„ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì „ ì„¸ê³„ ê²½ê¸° ì¹¨ì²´ ë•Œë¬¸ì…ë‹ˆë‹¤."
```

---

### **2ï¸âƒ£ ê²€ìƒ‰ í•¨ìˆ˜ì— Context ë°˜ê²½ ì¶”ê°€**

**íŒŒì¼**: `src/services/rag_service.py` ë¼ì¸ 415-462, 463-515 (ì‹ ê·œ)

#### **A. `hybrid_search()` ë©”ì„œë“œ ê°œì„ **

```python
async def hybrid_search(
    self,
    query: str,
    category: KnowledgeBaseCategory = None,
    limit: int = 5,
    semantic_weight: float = 0.3,
    include_context: bool = True,      # â† ì‹ ê·œ!
    context_radius: int = 1            # â† ì‹ ê·œ!
) -> List[Dict[str, Any]]:
```

**íŒŒë¼ë¯¸í„°**:
- `include_context`: True = ì£¼ë³€ ì²­í¬ í¬í•¨
- `context_radius`: 1 = ì•ë’¤ 1ê°œì”© ì²­í¬ í¬í•¨ (ì´ 3ê°œ ì²­í¬)

#### **B. `_expand_with_context()` ë©”ì„œë“œ ì¶”ê°€ (ì‹ ê·œ)**

```python
async def _expand_with_context(
    self,
    results: List[Dict[str, Any]],
    context_radius: int = 1
) -> List[Dict[str, Any]]:
    """ì¸ì ‘ ì²­í¬ë¥¼ í¬í•¨í•˜ì—¬ ê²°ê³¼ í™•ì¥"""
    
    # ì˜ˆ: context_radius=1ì¸ ê²½ìš°
    # ì›ë³¸ ì²­í¬ (chunk_2) + ì´ì „ ì²­í¬ (chunk_1) + ë‹¤ìŒ ì²­í¬ (chunk_3)
    # = ì´ 3ê°œ ì²­í¬ë¥¼ í•˜ë‚˜ë¡œ ë³‘í•©
```

**ë™ì‘ ë©”ì»¤ë‹ˆì¦˜**:
```
ê²€ìƒ‰ ê²°ê³¼: chunk_2 (chunk_index=2)
           â†“
         _expand_with_context(context_radius=1)
           â†“
       ê²½ê³„ ê³„ì‚°: start_idx = max(0, 2-1) = 1
                 end_idx = min(len, 2+1+1) = 4
           â†“
       ë²”ìœ„: chunks[1:4] = [chunk_1, chunk_2, chunk_3]
           â†“
       ë³‘í•©:
       "[Chunk 1] {...}"
       "[Chunk 2] {...}"
       "[Chunk 3] {...}"
           â†“
       ê²°ê³¼ì— ì¶”ê°€:
       - content: ë³‘í•©ëœ ì „ì²´ í…ìŠ¤íŠ¸
       - context_chunks_count: 3
       - context_range: "1~3"
```

**ë°˜í™˜ ë°ì´í„° ì˜ˆì‹œ**:
```python
{
    "content": "[Chunk 1] í•œêµ­ ê²½ì œê°€ ì–´ë ¤ì›Œì§€ê³ ...\n\n[Chunk 2] GDP ì„±ì¥ë¥ ì´ ê°ì†Œí•˜ê³ ...\n\n[Chunk 3] ì´ëŠ” ì „ ì„¸ê³„ ê²½ê¸° ì¹¨ì²´...",
    "original_chunk": "GDP ì„±ì¥ë¥ ì´ ê°ì†Œí•˜ê³ ...",  # ì›ë³¸ ë³´ì¡´
    "original_chunk_index": 2,
    "context_chunks_count": 3,
    "context_range": "1~3",
    "metadata": {...},
    "final_score": 0.85
}
```

---

### **3ï¸âƒ£ LLM í”„ë¡¬í”„íŠ¸ì— í™•ì¥ ì»¨í…ìŠ¤íŠ¸ ì ìš©**

**íŒŒì¼**: `src/services/rag_service.py` ë¼ì¸ 605-650, 651-690

#### **A. ì›Œí¬í”Œë¡œìš° ìƒì„± ì‹œ (`get_relevant_context_for_workflow_generation`)**

```python
# ë³€ê²½ ì „
results = await self.hybrid_search(
    query=user_input,
    category=category,
    limit=3,
    semantic_weight=0.3
)

# ë³€ê²½ í›„
results = await self.hybrid_search(
    query=user_input,
    category=category,
    limit=3,
    semantic_weight=0.3,
    include_context=True,      # âœ¨ í™œì„±í™”
    context_radius=1           # âœ¨ 1ì¹¸ì”© í™•ì¥
)

# max_tokensë„ ì¦ê°€
context = self.build_context(top_results, max_tokens=15000)  # 10000 â†’ 15000
```

#### **B. ì˜¤ë¥˜ í•´ê²° ì‹œ (`get_relevant_context_for_error_fix`)**

```python
# ë³€ê²½ ì „
results = await self.hybrid_search(
    query=error_message,
    category=KnowledgeBaseCategory.ERROR_SOLUTIONS,
    limit=5
)

# ë³€ê²½ í›„
results = await self.hybrid_search(
    query=error_message,
    category=KnowledgeBaseCategory.ERROR_SOLUTIONS,
    limit=5,
    include_context=True,      # âœ¨ í™œì„±í™”
    context_radius=1           # âœ¨ 1ì¹¸ì”© í™•ì¥
)
```

**íš¨ê³¼**:
- LLMì´ **ë” ì™„ì „í•œ ë¬¸ë§¥** ë°›ìŒ
- ì½”ë“œ ìƒì„± ì‹œ **í’ˆì§ˆ í–¥ìƒ**
- ì˜¤ë¥˜ í•´ê²° ì‹œ **ë” ì •í™•í•œ ì†”ë£¨ì…˜** ì œì‹œ

---

## ğŸ“Š ë³€ê²½ ì‚¬í•­ ìš”ì•½

| ë‹¨ê³„ | íŒŒì¼ | ë³€ê²½ ë‚´ìš© | íš¨ê³¼ |
|------|------|---------|------|
| 1ï¸âƒ£ | rag_service.py | chunk_size: 500â†’1000, overlap: 50â†’200 | ê¸°ë³¸ ì²­í¬ í¬ê¸° 2ë°° í™•ëŒ€ |
| 2ï¸âƒ£ | rag_service.py | `hybrid_search()` ê°œì„  + `_expand_with_context()` ì¶”ê°€ | ê²€ìƒ‰ ì‹œ ì¸ì ‘ ì²­í¬ ìë™ í¬í•¨ |
| 3ï¸âƒ£ | rag_service.py | `get_relevant_context_*` í•¨ìˆ˜ì— context í™•ì¥ ì ìš© | LLMì´ ì „ì²´ ë¬¸ë§¥ í™œìš© |

---

## ğŸ¯ ìµœì¢… íš¨ê³¼

### ì´ì „ (ë¬¸ì œì )
```
ì›ë³¸: "ê²½ì œ ì„±ì¥ë¥ ì´ ê°ì†Œí–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ìˆ˜ì¶œ ë¶€ì§„ ë•Œë¬¸ì…ë‹ˆë‹¤. 
      ì •ë¶€ê°€ ëŒ€ì±…ì„ ë§ˆë ¨í•˜ê³  ìˆìŠµë‹ˆë‹¤."

LLMì— ì „ë‹¬ëœ ì»¨í…ìŠ¤íŠ¸:
"ê²½ì œ ì„±ì¥ë¥ ì´ ê°ì†Œí–ˆìŠµë‹ˆë‹¤. ì´ëŠ”"

âŒ LLM: "ë¬´ì—‡ì´ ê°ì†Œí–ˆë‹¤ëŠ” ê±´ì§€ ë¶ˆëª…í™•"
âŒ ì½”ë“œ ìƒì„±: ë¶ˆì™„ì „
âŒ ì˜¤ë¥˜ìœ¨: ë†’ìŒ
```

### ì´í›„ (ê°œì„ ë¨)
```
ì›ë³¸: "ê²½ì œ ì„±ì¥ë¥ ì´ ê°ì†Œí–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ìˆ˜ì¶œ ë¶€ì§„ ë•Œë¬¸ì…ë‹ˆë‹¤. 
      ì •ë¶€ê°€ ëŒ€ì±…ì„ ë§ˆë ¨í•˜ê³  ìˆìŠµë‹ˆë‹¤."

LLMì— ì „ë‹¬ëœ ì»¨í…ìŠ¤íŠ¸:
"[Chunk 1] ê²½ì œ ì„±ì¥ë¥ ì´ ê°ì†Œí–ˆìŠµë‹ˆë‹¤.
 [Chunk 2] ì´ëŠ” ìˆ˜ì¶œ ë¶€ì§„ ë•Œë¬¸ì…ë‹ˆë‹¤. ì •ë¶€ê°€ ëŒ€ì±…ì„ ë§ˆë ¨í•˜ê³  ìˆìŠµë‹ˆë‹¤.
 [Chunk 3] ì •ë¶€ì˜ ê²½ê¸° ë¶€ì–‘ ì •ì±…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤..."

âœ… LLM: "ëª…í™•í•œ ì „ì²´ ë§¥ë½ ì´í•´"
âœ… ì½”ë“œ ìƒì„±: ì™„ì „í•˜ê³  ì •í™•
âœ… ì˜¤ë¥˜ìœ¨: í¬ê²Œ ê°ì†Œ
```

---

## ğŸ”§ ì„¤ì • íŠœë‹ ê°€ëŠ¥

### ë” ë§ì€ ì»¨í…ìŠ¤íŠ¸ í•„ìš” ì‹œ
```python
# context_radiusë¥¼ 2ë¡œ ì¦ê°€ (ì•ë’¤ 2ì¹¸ = 5ê°œ ì²­í¬)
results = await self.hybrid_search(
    query=query,
    include_context=True,
    context_radius=2  # 1 â†’ 2
)

# max_tokensë„ ì¦ê°€
context = self.build_context(results, max_tokens=20000)
```

### ì¢€ ë” ê°„ê²°í•œ ì»¨í…ìŠ¤íŠ¸ í•„ìš” ì‹œ
```python
# context í™•ì¥ ë¹„í™œì„±í™”
results = await self.hybrid_search(
    query=query,
    include_context=False  # True â†’ False
)
```

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### 1ï¸âƒ£ ê¸°ì¡´ ì§€ì‹ ë² ì´ìŠ¤ ì¬ì²˜ë¦¬ (ì„ íƒì‚¬í•­)
```
ê¸°ì¡´ ë¬¸ì„œë“¤ì´ ì‘ì€ ì²­í¬ë¡œ ì €ì¥ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ, 
ìƒˆë¡œìš´ ë¬¸ì„œ ì—…ë¡œë“œ ì‹œë¶€í„° ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.
```

### 2ï¸âƒ£ ì›Œí¬í”Œë¡œìš° ìƒì„±/ìˆ˜ì • í…ŒìŠ¤íŠ¸
```
ìƒˆë¡œìš´ ì›Œí¬í”Œë¡œìš° ìƒì„± â†’ ë” ì™„ì „í•œ ì½”ë“œ ìƒì„± í™•ì¸
ê¸°ì¡´ ì›Œí¬í”Œë¡œìš° ìˆ˜ì • â†’ ë” ì •í™•í•œ ì˜¤ë¥˜ í•´ê²° í™•ì¸
```

### 3ï¸âƒ£ ëª¨ë‹ˆí„°ë§
```
- RAG ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ ëª¨ë‹ˆí„°ë§
- LLM ìƒì„± ì½”ë“œ í’ˆì§ˆ ë¹„êµ
- ì˜¤ë¥˜ìœ¨ ì¶”ì´ ê´€ì°°
```

---

## ğŸ“ ê¸°ìˆ  ì„¸ë¶€ì‚¬í•­

### Context Expansion íë¦„ë„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hybrid Search ì‹¤í–‰             â”‚
â”‚  (semantic + keyword)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ê²°ê³¼ ì •ë ¬ ë° í•„í„°ë§              â”‚
â”‚  (final_score ê¸°ì¤€)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _expand_with_context() í˜¸ì¶œ     â”‚
â”‚  (include_context=True)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DBì—ì„œ ì¸ì ‘ ì²­í¬ ì¡°íšŒ            â”‚
â”‚  (context_radius ë²”ìœ„)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì²­í¬ ë³‘í•©                       â”‚
â”‚  ("[Chunk N] ...")               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë©”íƒ€ë°ì´í„° ì¶”ê°€                  â”‚
â”‚  (context_chunks_count, etc)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM í”„ë¡¬í”„íŠ¸ì— ì „ë‹¬             â”‚
â”‚  (ì „ì²´ ë¬¸ë§¥ í¬í•¨)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í† í° ì‚¬ìš©ëŸ‰ ë¹„êµ

| êµ¬ë¶„ | ì´ì „ | ì´í›„ | ì¦ê°€ìœ¨ |
|------|------|------|--------|
| ê¸°ë³¸ ì²­í¬ í¬ê¸° | 500 í† í° | 1000 í† í° | +100% |
| ì˜¤ë²„ë© | 50 í† í° | 200 í† í° | +300% |
| ê²€ìƒ‰ ê²°ê³¼ ì²­í¬ ìˆ˜ | 1 | 3 (context_radius=1) | +200% |
| max_tokens | 10,000 | 15,000 | +50% |

---

## âš™ï¸ êµ¬í˜„ ìƒì„¸

### ë³€ê²½ëœ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜

```python
# 1. chunk_text() - ê¸°ë³¸ ì²­í‚¹
def chunk_text(
    self,
    text: str,
    chunk_size: int = 1000,    # â†‘ 500â†’1000
    overlap: int = 200          # â†‘ 50â†’200
) -> List[str]

# 2. hybrid_search() - í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰
async def hybrid_search(
    self,
    query: str,
    category: KnowledgeBaseCategory = None,
    limit: int = 5,
    semantic_weight: float = 0.3,
    include_context: bool = True,   # â† ì‹ ê·œ
    context_radius: int = 1         # â† ì‹ ê·œ
) -> List[Dict[str, Any]]

# 3. _expand_with_context() - ì»¨í…ìŠ¤íŠ¸ í™•ì¥ (ì‹ ê·œ)
async def _expand_with_context(
    self,
    results: List[Dict[str, Any]],
    context_radius: int = 1
) -> List[Dict[str, Any]]

# 4. get_relevant_context_for_workflow_generation() - ì›Œí¬í”Œë¡œìš° ì»¨í…ìŠ¤íŠ¸
async def get_relevant_context_for_workflow_generation(
    self,
    user_input: str
    # include_context=True, context_radius=1 ì ìš©ë¨
)

# 5. get_relevant_context_for_error_fix() - ì˜¤ë¥˜ í•´ê²° ì»¨í…ìŠ¤íŠ¸
async def get_relevant_context_for_error_fix(
    self,
    error_message: str,
    workflow_context: str = None
    # include_context=True, context_radius=1 ì ìš©ë¨
)
```

---

ì´ì œ LLMì´ **ì™„ì „í•œ ë¬¸ë§¥ì„ ê¸°ë°˜ìœ¼ë¡œ** ë” ì •í™•í•˜ê³  ì™„ì„±ë„ ë†’ì€ ì›Œí¬í”Œë¡œìš°ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ‰
